import{d as U}from"./pinia-B2SWLoi0.js";import{a as L}from"./index-CET3MO9v.js";import{r as j,f as w}from"./vendor-C_kCRdsv.js";class E{dbName="PubSubMessageTemplates";dbVersion=1;storeName="templates";db=null;async open(){return this.db?this.db:new Promise((e,s)=>{const o=indexedDB.open(this.dbName,this.dbVersion);o.onerror=()=>s(o.error),o.onsuccess=()=>{this.db=o.result,e(this.db)},o.onupgradeneeded=c=>{const u=c.target.result;if(!u.objectStoreNames.contains(this.storeName)){const l=u.createObjectStore(this.storeName,{keyPath:"id"});l.createIndex("projectId","projectId",{unique:!1}),l.createIndex("topicName","topicName",{unique:!1}),l.createIndex("name","name",{unique:!1}),l.createIndex("createdAt","createdAt",{unique:!1}),l.createIndex("updatedAt","updatedAt",{unique:!1}),l.createIndex("projectTopic",["projectId","topicName"],{unique:!1}),l.createIndex("projectName",["projectId","name"],{unique:!0})}}})}async saveTemplate(e){const s=await this.open();if((await this.getTemplates(e.projectId)).find(d=>d.name===e.name))throw new Error(`Template "${e.name}" already exists in this project`);const u=`template-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,l=new Date,n={...e,id:u,createdAt:l,updatedAt:l};return new Promise((d,m)=>{const h=s.transaction([this.storeName],"readwrite").objectStore(this.storeName).add(n);h.onsuccess=()=>d(n),h.onerror=()=>m(h.error)})}async getTemplates(e){const s=await this.open();return new Promise((o,c)=>{const l=s.transaction([this.storeName],"readonly").objectStore(this.storeName);let n;e?n=l.index("projectId").getAll(e):n=l.getAll(),n.onsuccess=()=>{const d=n.result.map(m=>({...m,createdAt:new Date(m.createdAt),updatedAt:new Date(m.updatedAt)}));o(d)},n.onerror=()=>c(n.error)})}async getTemplate(e){const s=await this.open();return new Promise((o,c)=>{const n=s.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);n.onsuccess=()=>{const d=n.result;o(d?{...d,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt)}:null)},n.onerror=()=>c(n.error)})}async updateTemplate(e,s){const o=await this.open(),c=await this.getTemplate(e);if(!c)throw new Error("Template not found");const u={...c,...s,id:e,updatedAt:new Date};return new Promise((l,n)=>{const v=o.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(u);v.onsuccess=()=>l(u),v.onerror=()=>n(v.error)})}async deleteTemplate(e){const s=await this.open();return new Promise((o,c)=>{const n=s.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);n.onsuccess=()=>o(),n.onerror=()=>c(n.error)})}async clearTemplates(e){const s=await this.open();if(e){const c=(await this.getTemplates(e)).map(u=>this.deleteTemplate(u.id));await Promise.all(c)}else return new Promise((o,c)=>{const n=s.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();n.onsuccess=()=>o(),n.onerror=()=>c(n.error)})}}const g=new E,B=U("messageTemplates",()=>{const f=L(),e=j({state:"idle",error:null,lastUpdated:null}),s=j([]),o=j(null),c=w(()=>f.selectedProject?s.value.filter(t=>t.projectId===f.selectedProject.projectId):[]),u=w(()=>{const t={};return c.value.forEach(a=>{t[a.topicName]||(t[a.topicName]=[]),t[a.topicName].push(a)}),t}),l=w(()=>({total:c.value.length,byTopic:Object.keys(u.value).length,withVariables:c.value.filter(t=>Object.keys(t.variables).length>0).length,withAttributes:c.value.filter(t=>Object.keys(t.attributes).length>0).length})),n=w(()=>e.value.state==="loading"),d=w(()=>e.value.state==="error");async function m(){try{e.value.state="loading",e.value.error=null;const t=await g.getTemplates();s.value=t,e.value.state="success",e.value.lastUpdated=new Date}catch(t){throw e.value.state="error",e.value.error=t.message,t}}async function v(t){try{e.value.state="loading",e.value.error=null;const a=await g.saveTemplate(t);return s.value.push(a),e.value.state="success",e.value.lastUpdated=new Date,a}catch(a){throw e.value.state="error",e.value.error=a.message,a}}async function b(t,a){try{e.value.state="loading",e.value.error=null;const r=await g.updateTemplate(t,a),p=s.value.findIndex(i=>i.id===t);return p!==-1&&(s.value[p]=r),o.value?.id===t&&(o.value=r),e.value.state="success",e.value.lastUpdated=new Date,r}catch(r){throw e.value.state="error",e.value.error=r.message,r}}async function h(t){try{e.value.state="loading",e.value.error=null,await g.deleteTemplate(t);const a=s.value.findIndex(r=>r.id===t);a!==-1&&s.value.splice(a,1),o.value?.id===t&&(o.value=null),e.value.state="success",e.value.lastUpdated=new Date}catch(a){throw e.value.state="error",e.value.error=a.message,a}}async function N(t,a){try{const r=s.value.find(T=>T.id===t);if(!r)throw new Error("Template not found");const i={name:a||`${r.name} (Copy)`,description:r.description,projectId:r.projectId,topicName:r.topicName,data:r.data,attributes:{...r.attributes},variables:{...r.variables},tags:r.tags?[...r.tags]:void 0};return await v(i)}catch(r){throw e.value.state="error",e.value.error=r.message,r}}function I(t){o.value=t}function x(){o.value=null}function P(t){return s.value.find(a=>a.id===t)}function A(t,a){const r=a||f.selectedProject?.projectId;return r?s.value.filter(p=>p.topicName===t&&p.projectId===r):[]}function S(t,a){const r=a||f.selectedProject?.projectId;if(!r)return[];const p=t.toLowerCase();return s.value.filter(i=>i.projectId!==r?!1:i.name.toLowerCase().includes(p)||i.description?.toLowerCase().includes(p)||i.topicName.toLowerCase().includes(p)||i.tags?.some(T=>T.toLowerCase().includes(p)))}async function D(t){try{e.value.state="loading",e.value.error=null;let a=0;const r=[];for(const p of t)try{const i={...p,id:`template-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:new Date,updatedAt:new Date};s.value.find(y=>y.name===i.name&&y.projectId===i.projectId)&&(i.name=`${i.name} (Imported)`),s.value.push(i),a++}catch(i){r.push(`Failed to import template "${p.name}": ${i.message}`)}return a>0,e.value.state="success",e.value.lastUpdated=new Date,r.length>0&&console.warn("Import errors:",r),a}catch(a){throw e.value.state="error",e.value.error=a.message,a}}function q(t){const a=t||f.selectedProject?.projectId;return a?s.value.filter(r=>r.projectId===a):[]}async function $(t){await g.clearTemplates(t),s.value=s.value.filter(a=>a.projectId!==t),o.value?.projectId===t&&(o.value=null)}function C(){s.value=[],o.value=null,e.value={state:"idle",error:null,lastUpdated:null}}return{state:e,templates:s,selectedTemplate:o,currentProjectTemplates:c,templatesByTopic:u,templateStats:l,isLoading:n,hasError:d,loadTemplates:m,saveTemplate:v,updateTemplate:b,deleteTemplate:h,duplicateTemplate:N,selectTemplate:I,clearSelectedTemplate:x,getTemplate:P,getTemplatesByTopic:A,searchTemplates:S,importTemplates:D,exportTemplates:q,clearProjectTemplates:$,reset:C}});export{B as u};
